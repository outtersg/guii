#!/bin/sh
# Copyright (c) 2006 Guillaume Outters
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

set -e

absolutiseScripts() { SCRIPTS="$1" ; echo "$SCRIPTS" | grep -q ^/ || SCRIPTS="`dirname "$2"`/$SCRIPTS" ; } ; absolutiseScripts "`command -v "$0"`" "`pwd`/." ; while [ -h "$SCRIPTS" ] ; do absolutiseScripts "`readlink "$SCRIPTS"`" "$SCRIPTS" ; done ; SCRIPTS="`dirname "$SCRIPTS"`"
. "$SCRIPTS/util.sh"

inclure db
inclure sqlite
inclure dovecot

logiciel=exim

# Historique des versions gérées

v 4.77 && modifs="lthr" || true
v 4.80.1 && modifs="lthr paf" && prerequis="pcre" || true
v 4.82
v 4.82.1
v 4.87 || true

prerequis

# Modifications

paf()
{
	cp $HOME/src/projets/paf/paf.c Local/ || true
	echo "LOCAL_SCAN_SOURCE=Local/paf.c" >> Local/Makefile
	echo "LOCAL_SCAN_HAS_OPTIONS=yes" >> Local/Makefile
}

lthr()
{
	case `uname` in
		FreeBSD)
			cat > $TMP/$$/testpthr.c <<TERMINE
#include <pthread.h>
int main(int argc, char ** argv)
{
	pthread_create(NULL, NULL, NULL, NULL);
}
TERMINE
			for BIBLIOS_PTHREAD in "" "-lthr"
			do
				cc -o $TMP/$$/testphr $TMP/$$/testpthr.c "$BIBLIOS_PTHREAD" 2> /dev/null >&2 && break || true
			done
			;;
	esac
}

# Variables

dest="$INSTALLS/$logiciel-$version"
archive="http://exim.mirror.fr/exim/exim4/$logiciel-$version.tar.bz2"

[ -d "$dest" ] && exit 0

obtenirEtAllerDansVersion

echo Correction… >&2
for modif in true $modifs ; do $modif ; done

echo Configuration… >&2
# Avec ou sans LDAP?
if false
then
	BIBLIOS_LDAP="-lldap -llber"
else
	CONF_LDAP="# "
fi
sed < src/EDITME >> Local/Makefile \
	-e "/^BIN_DIRECTORY=/s#=.*#=$dest/bin#" \
	-e "/^CONFIGURE_FILE=/s#=.*#=$dest/etc/exim#" \
	-e "/^EXIM_USER=/s#=.*#=postfix#" \
	-e "/^SPOOL_DIRECTORY=/s#=.*#=$dest/var/spool/exim#" \
	-e "/^EXIM_MONITOR=/s#=.*#=#" \
	-e "/^# LOOKUP_LDAP=yes/s/^# /$CONF_LDAP/" \
	-e "/^# LOOKUP_PASSWD=yes/s/^# //" \
	-e "/^# LOOKUP_SQLITE=yes/s/^# //" \
	-e "/^# AUTH_DOVECOT=yes/s/^# //" \
	-e "/^# SUPPORT_PAM=yes/s/^# //" \
	-e "/^# SUPPORT_MAILDIR=yes/s/^# //" \
	-e "/^# LDAP_LIB_TYPE=OPENLDAP2/s/^# /$CONF_LDAP/" \
	-e '/^# LOOKUP_INCLUDE=/{
a\
LOOKUP_INCLUDES='"-I$INSTALLS/include"'
}' \
	-e '/^# LOOKUP_LIBS=/a\
LOOKUP_LIBS='"-L$INSTALLS/lib $BIBLIOS_LDAP -lsqlite3 -ldb -lpam $BIBLIOS_PTHREAD"'
' \
	-e '${
a\
USE_DB=yes
a\
CC=cc $(LOOKUP_INCLUDES)
a\
LDCC=cc $(LOOKUP_INCLUDES) $(LOOKUP_LIBS)
a\
LIBS += $(PCRE_LIBS) $(LOOKUP_LIBS)
}'

echo Compilation… >&2
make || ( filtrer build-`uname`-`uname -m`/Makefile sed -e '/^\.if/,/^\.endif/d' && make )

echo Installation… >&2
sudo make install
sudo mkdir -p "$dest/var/spool/exim/log"
sudo chown -R postfix "$dest/var"
sutiliser "$logiciel-$version"
[ -h /usr/sbin/sendmail -o ! -e /usr/sbin/sendmail ] && sudo rm -f /usr/sbin/sendmail && sudo ln -s "$dest/bin/exim" /usr/sbin/sendmail

rm -Rf "$TMP/$$"

exit 0

# Pour tester:
read mdp
adrip="`ifconfig | grep inet | cut -d ' ' -f 2 | head -1`"
lisRes()
{
	grep --max-count=1 "$1" > /tmp/temp.$$.rep
	grep -q "^5" < /tmp/temp.$$.rep && echo QUIT && touch /tmp/temp.$$.rate && exit 0 || true
}
cause()
{
	if [ -z "$chut" ]
	then
		tee -a /dev/tty
	else
		tee -a /tmp/temp.$$.trace
	fi
}
envoi()
{
	auth=oui
	[ "x$1" = x--sans-auth ] && shift && auth=non
	adr=$adrip
	[ "x$1" = x--localhost ] && shift && adr=127.0.0.1
	fichier=
	[ "x$1" = x--fichier ] && shift && fichier="$1" && shift
	dequiaffiche=
	[ "x$1" = x-f ] && shift && dequiaffiche="$1" && shift
	quoi="$1"
	dequi="$2"
	[ "x$dequiaffiche" = x ] && dequiaffiche="$dequi"
	aqui="$3"
	dequiauth="`echo "$dequi" | sed -e 's/-[^@]*@/@/'`"
	plain=`printf ^$dequiauth^$mdp | tr ^ '\000' | openssl base64`
	mkfifo /tmp/temp.$$.fifo
	rm -f /tmp/temp.$$.rate
	cat /tmp/temp.$$.fifo | (
		grep -q ESMTP
		echo EHLO `hostname`
		grep -q "250 "
		[ $auth = oui ] && echo AUTH PLAIN $plain && grep -q "235 "
		echo "MAIL FROM:<$dequi>"
		lisRes "[25]50 "
		echo RCPT TO: $aqui
		lisRes "[25]50 "
		echo DATA
		grep -q "354 "
		if [ -z "$fichier" ]
		then
			echo Subject: essai de Guillaume $quoi
			echo From: $dequiaffiche
			echo
			echo COUCOU DE $dequi
		else
			cat "$fichier"
		fi
		echo .
		grep -q "250 "
		echo QUIT
		grep -q "221 "
	) | cause | telnet $adr 25 2>&1 | cause > /tmp/temp.$$.fifo
	rm /tmp/temp.$$.fifo
	echo "$quoi" | cut -d ' ' -f 1 | tr -d '\012'
	oui=Oui
	[ -e /tmp/temp.$$.rate ] && oui=Non || true
	couleur='@[0;31m'
	echo "$quoi" | grep -q "^$oui" && couleur='@[0;32m' || true
	echo ": $couleur$oui"'@[0m' | tr @ '\033'
}
chut=1
dlemis=gclo.fr
dlrecu=outters.eu
externe=guillaume.outters@free.fr
envoi Oui1 gui-envoyant@$dlemis guillaume-destinataire@$dlrecu
envoi -f guidouille-envoyant@$dlemis OuiMais1 gui-envoyant@$dlemis guillaume-destinataire@$dlrecu # Oui, mais From forcé à ce qui est réécrit.
envoi --sans-auth Non1 gui@$dlemis guillaume-destinataire@$dlrecu # Interne non authentifié interdit
envoi --sans-auth Oui2 $externe guillaume-destinataire@$dlrecu # Externe vers interne: sans auth
envoi --sans-auth --localhost Oui3 fournil@$dlrecu guillaume-destinataire@$dlrecu # Du moment qu'il est référencé dans $dlrecu.automates, ça passe (serveur PHP émettant).
# À FAIRE: tester avec une redirection (mathilde-logistique -> externe, par exemple; vérifier DKIM); et en sens inverse.
envoi --sans-auth --localhost Non2 fourmil@$dlrecu guillaume-destinataire@$dlrecu # Un serveur local qui n'est pas inscrit se fait jeter.
echo "COUCOU de `id`" | mail -s "essai de Guillaume Oui4" guillaume@$dlrecu
( echo "From: fournil@$dlrecu" ; echo "Subject: essai de Guillaume Oui5" ; echo ; echo "COUCOU de `id`" ; echo . ) | sendmail guillaume@$dlrecu # gui est autorisé à envoyer sous le nom fournil@$dlemis
( echo "From: Fournil <fournil@$dlrecu>" ; echo "Subject: essai de Guillaume Oui6" ; echo ; echo "COUCOU de `id`" ; echo . ) | sendmail guillaume@$dlrecu # le même avec un From un poil plus complexe.
( echo "From: Fournil <fourmille@$dlrecu>" ; echo "Subject: essai de Guillaume Non3" ; echo ; echo "COUCOU de `id`" ; echo . ) | sendmail guillaume@$dlrecu # Mais interdit si on ne figure pas dans la liste des autorisés!
envoi Oui41 gui-envoyant@$dlemis $externe
envoi --sans-auth Non40 $externe $externe # Relai interdit
echo "COUCOU de `id`" | mail -s "essai de Guillaume Oui42" $externe # Juste parce que l'utilisateur courant a été autorisé dans ici.la.automates.
( echo "From: Fournil <fournil@$dlrecu>" ; echo "Subject: essai de Guillaume Oui43" ; echo ; echo "COUCOU de `id`" ; echo . ) | sendmail $externe # test sendmail en externe.
